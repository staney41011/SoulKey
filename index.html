<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <title>週週打開心靈的鎖匙課程 DM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
   
  <style>
    body { background-color: #f4f6f9; font-family: "Microsoft JhengHei", sans-serif; }
    
    /* 深藍到綠色的漸層表頭 */
    .header-banner { 
      background: linear-gradient(135deg, #2c3e50 0%, #27ae60 100%); 
      color: white; 
      padding: 2.5rem 1rem; 
      text-align: center; 
      margin-bottom: 2rem; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
    }
    
    /* 卡片樣式 */
    .card { border: none; border-radius: 12px; overflow: hidden; margin-bottom: 1.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    .card-header { background-color: #fff; border-bottom: 1px solid #f0f0f0; font-weight: bold; color: #333; padding: 1rem; }
    
    .img-wrapper { position: relative; background-color: #fafafa; padding: 10px; text-align: center; min-height: 200px; }
    .img-fluid { width: 100%; height: auto; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    
    .btn-action { width: 100%; border-radius: 50px; font-weight: bold; margin-top: 10px; display: flex; align-items: center; justify-content: center; padding: 8px 0; }
    .btn-line { background-color: #06c755; color: white; border: none; }
    .btn-line:hover { background-color: #05b34c; color: white; }
    .btn-download { color: #198754; border-color: #198754; }
    .btn-download:hover { background-color: #198754; color: white; }
    
    .loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
  
    /* 管理員按鈕區域 */
    .admin-section { margin-top: 50px; padding: 20px; text-align: center; border-top: 1px solid #ddd; }
    .btn-update { background-color: #2c3e50; color: white; border-radius: 50px; padding: 10px 30px; font-weight: bold; }
    .btn-update:hover { background-color: #1a252f; color: white; }
    .btn-update:disabled { background-color: #ccc; cursor: not-allowed; }
  </style>
</head>
<body>

  <div id="loading" class="loading-screen">
    <div class="spinner-border text-success" style="width: 3rem; height: 3rem;" role="status"></div>
    <p class="mt-3 text-secondary fw-bold" id="loading-text">正在讀取 GitHub 資料...</p>
  </div>

  <div id="main-content" style="display: none;">
    <div class="header-banner">
      <h1 class="fw-bold mb-2" id="page-title">週週打開心靈的鎖匙課程 DM</h1>
      <p class="mb-0 opacity-75" id="page-subtitle"></p>
    </div>

    <div class="container pb-5">
      <div class="row" id="cards-container"></div>
      
      <div class="admin-section">
        <p class="text-muted small mb-3">
          <i class="fas fa-cog me-1"></i> 管理員專區
        </p>
        <button id="btn-update" class="btn btn-update" onclick="triggerUpdate()">
          <i class="fas fa-sync-alt me-2"></i> 同步更新圖片 (GitHub)
        </button>
        <p id="update-status" class="mt-2 small text-muted"></p>
      </div>

      <div class="text-center mt-3 text-muted small"><p>圖片資料來源：GitHub Pages</p></div>
    </div>
  </div>

  <script>
    // ==============================================
    // 設定您的 GitHub Pages 資料網址
    // ==============================================
    const USERNAME = "staney41011";
    const REPO = "SoulKey";
    const DATA_URL = `https://${USERNAME}.github.io/${REPO}/images/data.json`;

    window.onload = function() {
      // 載入時讀取 GitHub 上的資料
      fetch(DATA_URL + "?t=" + new Date().getTime())
        .then(response => response.json())
        .then(data => renderPage(data))
        .catch(error => {
           console.warn("讀取 GitHub 失敗", error);
           document.getElementById('loading').style.display = 'none';
           document.getElementById('main-content').style.display = 'block';
           document.getElementById('cards-container').innerHTML = '<div class="alert alert-info text-center">目前 GitHub 上沒有資料，請點擊下方「同步更新」按鈕來初始化。</div>';
        });
    };

    function renderPage(data) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
      
      // --- 【更新】標題與日期邏輯 ---
      let titleText = "週週打開心靈的鎖匙課程 DM"; // 預設標題
      let subText = ""; // 預設副標題清空

      if (data.period) {
        // 顯示：第 216 期 - 週週打開心靈的鎖匙課程 DM
        titleText = `第 ${data.period} 期 - ${titleText}`;
      }

      if (data.date) {
        // 副標題只顯示日期，例如：(2026/01/04)
        subText = `(${data.date})`;
      }

      document.getElementById('page-title').innerText = titleText;
      document.getElementById('page-subtitle').innerText = subText;
      // ----------------------------

      const container = document.getElementById('cards-container');
      let html = '';

      if (!data.items || data.items.length === 0) {
        container.innerHTML = '<div class="alert alert-warning text-center">無圖片資料。</div>';
        return;
      }

      data.items.forEach(item => {
        // 分享時的文字也同步更新
        const shareTitle = `${titleText} ${subText} ${item.lang}DM`;
        const imgUrl = `https://${USERNAME}.github.io/${REPO}/${item.imageUrl}`;

        html += `
          <div class="col-md-6 col-lg-4">
            <div class="card h-100">
              <div class="card-header d-flex justify-content-between align-items-center">
                <div><i class="fas fa-language me-2 text-success"></i>${item.lang}版</div>
              </div>
              <div class="card-body p-0">
                  <div class="img-wrapper">
                    <img src="${imgUrl}" class="img-fluid" alt="${item.lang}">
                  </div>
              </div>
              <div class="card-body pt-0 pb-3 px-3">
                ${navigator.share ? `
                <button onclick="shareImage('${shareTitle}', '${imgUrl}')" class="btn btn-line btn-action">
                  <i class="fab fa-line me-2"></i> 分享圖片到 LINE
                </button>
                ` : ''}
                <a href="${imgUrl}" download="${item.lang}_DM.png" class="btn btn-outline-success btn-sm btn-download btn-action">
                  <i class="fas fa-download me-2"></i> 下載圖片
                </a>
              </div>
              <div class="card-footer bg-light text-muted small text-center py-2">
                ${item.lang}版 DM
              </div>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    // 單張分享圖片檔案
    async function shareImage(title, url) {
      try {
        const response = await fetch(url);
        const blob = await response.blob();
        const file = new File([blob], "dm.png", { type: "image/png" });
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({ files: [file], title: title, text: title });
        } else {
          alert("您的裝置不支援直接分享圖片，請使用下載功能。");
        }
      } catch (error) {
        alert("分享失敗，請稍後再試。");
      }
    }

    // ==============================================
    // 觸發更新功能 (含密碼保護)
    // ==============================================
    function triggerUpdate() {
      const btn = document.getElementById('btn-update');
      const status = document.getElementById('update-status');
      
      const password = prompt("請輸入管理員密碼以執行更新：", "");

      if (password === null) return;

      if (password !== "184179") {
        alert("❌ 密碼錯誤！無法執行更新。");
        return;
      }
      
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>處理中...';
      status.innerText = "正在通知 GitHub 機器人下載新圖...";

      google.script.run
        .withSuccessHandler(function(res) {
          btn.innerHTML = '<i class="fas fa-check me-2"></i> 已發送指令';
          status.innerHTML = "<span class='text-success'><strong>成功！</strong> 機器人正在背景下載圖片。<br>請約 1 分鐘後重新整理此頁面查看新圖。</span>";
          setTimeout(() => { 
            btn.disabled = false; 
            btn.innerHTML = '<i class="fas fa-sync-alt me-2"></i> 同步更新圖片 (GitHub)'; 
          }, 10000);
        })
        .withFailureHandler(function(err) {
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i> 重試';
          status.innerHTML = "<span class='text-danger'>錯誤: " + err.message + "</span>";
        })
        .triggerGitHubAction();
    }
  </script>
</body>
</html>
